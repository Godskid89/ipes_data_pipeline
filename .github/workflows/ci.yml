name: IPES Pipeline CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Install Playwright browsers (required for download_pdfs_robust.py import, even if not running)
        playwright install chromium

    - name: Security Check (Safety)
      run: |
        safety check

    - name: Lint with Flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Verify Data Structure Logic (Integration Test)
      # We skip fetch/download (requires API keys/Time) but verify logic
      # We mock the input file for the test
      run: |
        # Create a dummy input file matching actual FCC API schema
        mkdir -p data/raw data/structured data/enriched data/monitoring
        cat > data/raw/ipes_filings.json << 'EOF'
        [
          {
            "submission_id": "1234567890",
            "company_name": "Test Telecom LLC",
            "date_received": "2024-01-15",
            "submission_type": "APPLICATION",
            "docket_number": "INBOX-52.15",
            "proceeding_description": "VoIP Numbering Authorization Application (Fee Required)",
            "bureau": "Wireline Competition Bureau",
            "filing_status": "DISSEMINATED",
            "contact_attorney": "",
            "law_firm": "",
            "document_urls": "",
            "detail_url": "https://www.fcc.gov/ecfs/filing/1234567890"
          },
          {
            "submission_id": "9876543210",
            "company_name": "Test Communications Inc.",
            "date_received": "2024-02-20",
            "submission_type": "APPLICATION",
            "docket_number": "25-100",
            "proceeding_description": "Interconnected VoIP Numbering Authorization Application Filed By Test Communications Inc. Pursuant To Section 52.15(g)(3)",
            "bureau": "Wireline Competition Bureau",
            "filing_status": "DISSEMINATED",
            "contact_attorney": "",
            "law_firm": "",
            "document_urls": "",
            "detail_url": "https://www.fcc.gov/ecfs/filing/9876543210"
          }
        ]
        EOF
        
        # Run Structure Step (Testing Deduplication & Schema Validation)
        python3 code/structure_data.py
        
        # Verify outputs were created
        test -f data/structured/companies.csv && echo "✓ companies.csv created"
        test -f data/structured/filings.csv && echo "✓ filings.csv created"

